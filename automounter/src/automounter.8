.\"
.\" Copyright (c) 2008 - 2010
.\" Dominic Fandrey <kamikaze@bsdforen.de>
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"
.Dd Apr 9, 2010
.Dt AUTOMOUNTER 8
.Os
.Sh NAME
.Nm automounter
.Nd Dynamically configure amd for existing devices.
.Sh SYNOPSIS
.Nm
.Pq Ar start | Ar update | Ar list | Ar stop
.Nm
.Ar list
.Op Ar mounted | Ar labels | Ar keys | Ar encrypted
.Sh DESCRIPTION
The
.Nm
script dynamically builds a map file for
.Xr amd 8 .
It is meant to be started by the
.Xr rc 8
system and trigerred by
.Xr devd 8
when devices appear or disappear.
.Pp
By default
.Nm
copies the file %%MAP%% and builds its configuration on top of that.
This means it inherits everything defined there and amd_enable="YES" should
.Ar not
be set in
.Xr rc.conf 5 .
.Pp
The script also supports polling the keys of
.Xr geli 8
encrypted partitions and images from managed media.
More information is available in the
.Ar GELI
section of this manual page.
.Pp
This manual page describes how to set up
.Nm .
How to adjust its behaviour is described in the
.Xr automounter.conf 5
manual page.
.Sh OPTIONS
The following options are available:
.Bl -tag -width indent
.It Ar start
Starts
.Xr amd 8
and calls update.
.It Ar update
Updates the dynamic map file for
.Xr amd 8
and creates the necessary mount points and links. It also removes stale
mount points and links.
.It Ar list
Lists the labels of currently managed mounts, the keys found on the media and
the encrypted providers that are available.
.It Ar list mounted
Lists the currently mounted labels.
.It Ar list keys
Lists the keys that were found on the managed media.
.It Ar list encrypted
Lists the images and devices that are available. If attached, the media that
contains the key will also be listed.
.It Ar stop
Unmount everything, stop
.Xr amd 8
and clean everything up.
.El
.Pp
Unsupported parameters will cause printing of supported parameters.
.Sh NOTES
Automounter is made for the sake of comfort. Even though it reduces the
probabilty of panics, the user is still oblieged to run
.Xr mount 8
to make sure a device is not mounted, before unplugging it.
.Pp
.Fx 7.1 and higher normally do no longer panic when a mounted device
disappears, however it still remains
.Dq bad style
to unplug mounted media.
.Sh IMPLEMENTATION NOTES
This manual section is for the technically interested, to setup
.Nm
skip ahead to
.Sx STARTUP .
.Pp
.Nm
is not a daemon, instead it relies on
.Xr amd 8
to perform the daemonic task of dynamically mounting file systems.
.Pp
The purpuse of
.Nm
is to discover mountable file systems and create an
.Xr amd 8
map file. This also entails recording discoveries, creating a link structure
in %%MEDIA%% and not loosing any devices during operation, which is the
most difficult task of all.
.Ss States Of Operation
.Nm
knows two states of operation, stopped and started. This is necessary to
ensure that the system has been initialized before starting. The start
call will be performed by the
.Xr rc 8
system, which will cause
.Nm
to start
.Xr amd 8
and perform the first update, which will discover available file systems.
.Pp
If properly configured premature update calls might be issued by
.Xr devd 8
during boot. These will be ignored.
.Ss Device Discovery
The first activity during an update call is device discovery. The entire
configuration is rebuilt every time an update is called. To this
end detector functions are called. The current detector functions are
named mountedDetect(), glabelDetect() and probeDetect(). Each of these
functions call the writeNode() function to record their findings and
set up the necessary directory and link structure. The writeNode()
function also performs the blacklisting checks. The detectors keep a list
of already probed devices, to avoid redundant work.
.Pp
The mounted detector discovers the currently mounted devices. This is
necessary, because mounting a glabel consumer destroys the glabel providers
and thus prevents discovery by the glabel detector.
The probe detector needs to be able to mount file systems, which does
not work with already mounted geom providers, so it depends on this, too.
.Pp
The glabel detector uses the
.Xr geom 8
label class to identify file system types through labels. This is the
traditional way of discovery for
.Nm .
.Pp
The probe detector takes the remaining geom providers reported by the
.Xr gstat 8
tool and simply tries to mount them as different file system types until
it succeeds or runs out of file system types. Successfully mounted
devices are unmonted and setup with writeNode().
.Pp
Afterwards the mount detector is called again to catch mounts that
occured after the first run and prevented detection through the other
detectors. This is a very unlikely case, but not entirely impossible.
.Ss Stale Mounts
The next step is to compare the list of previously discovered devices
and destroy the %%MEDIA%% link structure for each one that was not
discovered this time.
.Ss Reconfiguring AMD
Now that the device discovery is completed,
.Xr amd 8
is sent SIGHUP to reload the newly built map file. From this moment on the
discovered devices are available.
.Ss Encrypted Providers
Afterwards, if activated, the
.Xr geli 8
managing function is started.
.Pp
The geliUpdate() function checks whether it is currently managing keys
residing on no longer present file systems. The keys are removed from the
list of available keys.
.Pp
The next step is to search newly discovered file systems for keys.
.Pp
Afterwards a process for each encrypted file system whose key is no longer
available is forked off. This process tries to destroy the
.Xr geli 8
provider, which is only possible if the file system is not mounted. Otherwise
the process stays around until it has managed to destroy the provider or
until the key becomes available again. After successful destruction of the
provider the process starts a new update to ensure that keys provided by the
destroyed provider are no longer listed as available.
.Pp
The step before last is to decrypt the providers for which new keys are
available.
.Pp
Finally a new update is started, if the previous step succeeded in creating
decrypted providers.
.Ss Locking
Because the sequential order of events is critical to retain consistency
most of the operation of automounter is locked. I.e. start,
update, stop and umount are synchronous operations.
.Pp
Umounts, because they may not occur during device discovery, the others
because update runs may only occur one at a time. The locking ensures
that too many updates at once (e.g. lots of diconnect/connect events
reported by
.Xr devd 8
or the removal of several encrypted providers) will be called sequentially
or time out at a time when it can be assumed safely, that the discoveries
were already made by previous updates.
.Sh STARTUP
In order for the dynamic creation and destruction of mountpoints to work,
it is necessary that
.Nm
is started first. The recommended way to achieve this is by setting the
following line in
.Xr rc.conf 5 :
.Pp
	automounter_enable="YES"
.Pp
To start it without rebooting run the following command:
.Pp
	%%PREFIX%%/etc/rc.d/automounter start
.Sh DYNAMIC MOUNTS
To dynamically adjust mounts when USB storage devices appear add the
following lines to
.Xr devd.conf 5 :
.Bd -literal -offset indent
# Call automounter to update mounts.
attach 100 {
	device-name "umass[0-9]+";
	action "%%PREFIX%%/sbin/automounter update";
};
detach 100 {
	device-name "umass[0-9]+";
	action "%%PREFIX%%/sbin/automounter update";
};
.Ed
.Pp
If you want to see the output on the first terminal you can change the action
in the following way:
.Bd -literal -offset indent
"%%PREFIX%%/sbin/automounter update > /dev/ttyv0 2>&1"
.Ed
.Sh ACCESS RIGHTS
The mount point inherits the access rights of the label device node. This is
useful for file systems that don't support proper user management like msdosfs.
If any right is present for the owner, group or others the executable flag is
added to ensure that cding into the file system is possible.
.Pp
If the label device node is not found, e.g. because the label is empty, the
regular device node will be used instead.
.Pp
To find out how to change the access rights to a device node and hence of the
resulting mount point read the
.Xr devfs.rules 5
manual page.
.Sh GELI
The
.Nm
script is able to poll keys for encrypted images and devices from managed media
(such as a USB stick) and create the necessary device nodes to access these
images.  Images containing labeled partitions are detected like managed media
and can even contain keys themselves. Keys and labels will simply be updated
whenever new ones show up.
.Pp
If a used key disappears the encrypted device will be detached when no longer
in use.
.Pp
To activate and configure this feature please refer to the
.Ar GELI
section of the
.Xr automounter.conf 5
manual page.
.Pp
How to create images that can be mounted with a key (password authentication
is not supported) is described in the
.Xr geli 8
manual page. Keys are expected to reside in %%GELI_KEYS%% on a labeled
partition and the images are expected to be stored in %%GELI_IMAGES%%.
.Pp
Devices have to be unresolvable symlinks from %%GELI_IMAGES%%. E.g. if you wish
to enable auto attaching for %%DEVFS%%/da0s1 with a key named confidental you
have to create a link in the following fashion:
.Bd -literal -offset indent
ln -s da0s1 "%%GELI_IMAGES%%/confidental"
.Ed
.Sh FILES
.Bl -tag -width indent
.It %%PREFIX%%/sbin/automounter
.It %%PREFIX%%/etc/automounter.conf
.It %%PREFIX%%/etc/automounter.conf.sample
.It %%PREFIX%%/etc/rc.d/automounter
.El
.Sh BUGS/UNEXPECTED BEHAVIOUR
Fuse based filesystems like ntfs-3g close all openened files when amd tries to
unmount them. This is a bug in fuse and neither automounter nor amd are to
blame. A workaround for this bug is described in the
.Xr automounter.conf 5
manual page.
.Sh COMPATIBILITY
The script has been tested on FreeBSD 8.0-STABLE
.Sh SEE ALSO
.Xr automounter.conf 5 ,
.Xr amd 8 ,
.Xr rc 8 ,
.Xr rc.conf 5 ,
.Xr devd.conf 5 ,
.Xr devfs.rules 5 ,
.Xr geli 8
.Sh AUTHOR
Dominic Fandrey <kamikaze@bsdforen.de>
